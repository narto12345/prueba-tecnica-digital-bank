---

const today = new Date().toISOString().split("T")[0];
---

<form id="create-user">
  <label>
    Nombre:
    <input
      required
      id="name"
      type="text"
      placeholder="Escribe tu nombre"
      name="name"
      value=""
    />
  </label>

  <div>
    <label for="gender">Sexo:</label>
    <select required name="gender" id="gender">
      <option value="" disabled selected>-- Seleccione --</option>
      <option value="M">Masculino</option>
      <option value="F">Femenino</option>
    </select>
  </div>

  <div>
    <label for="birthDate">Fecha de nacimiento:</label>
    <input
      required
      id="birthDate"
      type="date"
      name="birthDate"
      max={today}
    />
  </div>

  <button type="submit">Crear</button>
</form>

<script>
  import { routes } from "@/config/routes";

  const form = document.getElementById("create-user") as HTMLFormElement;
  const nameEl = document.getElementById("name") as HTMLInputElement;
  const genderEl = document.getElementById("gender") as HTMLSelectElement;
  const birthDateEl = document.getElementById("birthDate") as HTMLInputElement;

  const params = new URLSearchParams(window.location.search);
  const action = params.get("action");
  const idParam = params.get("id");

  if (action === "update") {
    nameEl.value = params.get("name") ?? "";
    birthDateEl.value = params.get("birthDate") ?? "";
    genderEl.value = params.get("gender") ?? "";
  }

  form?.addEventListener("submit", async (event) => {
    event.preventDefault();

    const user = {
      id: idParam ? Number(idParam) : undefined,
      name: nameEl.value.trim(),
      gender: genderEl.value,
      birthdate: birthDateEl.value,
    };

    const isUpdate = action === "update";
    const method = isUpdate ? "PUT" : "POST";

    try {
      const response = await fetch(routes.users, {
        method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(user),
      });

      const data = await response.json();

      if (!response.ok) {
        console.error(
          `Error en ${isUpdate ? "actualización" : "creación"} de usuario:`,
          data
        );
        alert(
          `No se pudo ${isUpdate ? "actualizar" : "crear"} el usuario`
        );
      } else {
        console.log(
          `Usuario ${isUpdate ? "actualizado" : "creado"}:`,
          data
        );
        alert(`Usuario ${isUpdate ? "actualizado" : "creado"} con éxito`);

        window.location.href = window.location.pathname;
      }
    } catch (err) {
      console.error(err);
      alert("Error inesperado en la operación");
      window.location.href = window.location.pathname;
    }
  });
</script>
